{% extends 'base.html.twig' %}
{% block stylesheets %}
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fdf4ff 0%, #f0f9ff 100%);
      min-height: 100vh;
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Montserrat', sans-serif;
    }
    .fc {
      font-family: 'Poppins', sans-serif;
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .countdown-box {
      transition: transform 0.3s ease;
    }
    .countdown-box:hover {
      transform: scale(1.05);
    }
    .floating {
      animation: float 6s ease-in-out infinite;
    }
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
      100% { transform: translateY(0px); }
    }
    .gradient-bg {
      background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
    }
    .hero-pattern {
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23f472b6' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    .profile-card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    .upload-area {
      transition: all 0.3s ease;
    }
    .upload-area.dragover {
      border-color: #ec4899;
      background-color: #fdf2f8;
    }
    .image-loading {
      opacity: 0.7;
      filter: blur(2px);
    }
    .image-loaded {
      opacity: 1;
      filter: blur(0);
      transition: opacity 0.3s ease, filter 0.3s ease;
    }
  </style>
{% endblock %}
{% block body %}
{{ include('navbar.html.twig') }}

<div class="max-w-4xl mx-auto px-4 py-8">
  <!-- Encabezado con animación -->
  <div class="text-center mb-12 animate__animated animate__fadeInDown">
    <h2 class="text-4xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent">Mi Perfil</h2>
    <p class="text-gray-600 mt-4 text-lg">Gestiona tu información personal para una mejor experiencia en el Carnaval</p>
    <div class="w-24 h-1 bg-gradient-to-r from-pink-500 to-purple-600 mx-auto mt-6 rounded-full"></div>
  </div>

  {# Vista del perfil #}
  <div id="profileView" class="mb-8 profile-card rounded-3xl shadow-xl overflow-hidden animate__animated animate__fadeIn">
    <div class="p-8 md:p-10">
      <div class="flex flex-col md:flex-row items-center md:items-start gap-8">
        <div class="relative">
          <div class="relative rounded-full p-1 bg-gradient-to-r from-pink-500 to-purple-600">
            <img id="profileImage" src="{{ asset('images/default-avatar.png') }}" alt="avatar" 
                 class="w-36 h-36 rounded-full object-cover border-4 border-white shadow-xl image-loading">
            <div id="profileImageSpinner" class="absolute inset-0 flex items-center justify-center">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
            </div>
          </div>
          <div class="absolute -bottom-2 -right-2 w-12 h-12 rounded-full bg-gradient-to-r from-pink-500 to-purple-600 flex items-center justify-center text-white shadow-lg">
            <i class="fas fa-user text-lg"></i>
          </div>
        </div>
        
        <div class="flex-1 text-center md:text-left">
          <h3 id="profileName" class="text-3xl font-bold text-gray-800 mb-2">Cargando...</h3>
          <div class="flex items-center justify-center md:justify-start mb-4">
            <div class="flex text-amber-400">
              <i class="fas fa-star text-lg mr-1"></i>
              <i class="fas fa-star text-lg mr-1"></i>
              <i class="fas fa-star text-lg mr-1"></i>
              <i class="fas fa-star text-lg mr-1"></i>
              <i class="fas fa-star-half-alt text-lg"></i>
            </div>
            <span class="text-gray-500 ml-2">4.5/5</span>
          </div>
          <p id="profileBio" class="text-gray-600 text-lg leading-relaxed mb-6">Cargando información del perfil...</p>
        </div>
      </div>
      
      <div class="mt-10 pt-8 border-t border-gray-100 flex justify-center">
        <button id="editBtn" class="px-8 py-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-full shadow-lg hover:from-pink-600 hover:to-purple-700 hover:shadow-xl transition-all duration-300 font-semibold flex items-center group transform hover:scale-105">
          <i class="fas fa-edit mr-3 group-hover:animate-bounce"></i> 
          <span class="mr-2">Editar perfil</span>
          <i class="fas fa-arrow-right text-sm group-hover:translate-x-1 transition-transform duration-300"></i>
        </button>
      </div>
    </div>
  </div>

  {# Formulario de edición #}
  <div id="profileEdit" class="hidden glass-effect rounded-3xl shadow-2xl overflow-hidden">
    <div class="bg-gradient-to-r from-pink-500 to-purple-600 p-6 text-white text-center">
      <h3 class="text-2xl font-bold"><i class="fas fa-user-edit mr-3"></i> Editar Perfil</h3>
      <p class="text-base opacity-90 mt-2">Actualiza tu información personal</p>
    </div>
    
    <form id="profileForm" enctype="multipart/form-data" class="p-8 md:p-10">
      <!-- Campo Nombre -->
      <div class="mb-8">
        <label class="block text-gray-700 font-semibold mb-3 text-lg">
          <i class="fas fa-user text-pink-500 mr-2"></i> Nombre completo
        </label>
        <div class="relative">
          <input name="nombre" id="nombre" required 
                 class="w-full border border-gray-200 rounded-xl px-5 py-4 pl-12 focus:ring-2 focus:ring-pink-300 focus:border-pink-400 transition-all duration-300 outline-none text-lg shadow-sm" 
                 placeholder="Ingresa tu nombre completo" />
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <i class="fas fa-user text-gray-400 text-lg"></i>
          </div>
        </div>
      </div>

      <!-- Campo Biografía -->
      <div class="mb-8">
        <label class="block text-gray-700 font-semibold mb-3 text-lg">
          <i class="fas fa-pencil-alt text-pink-500 mr-2"></i> Biografía
        </label>
        <div class="relative">
          <textarea name="biografia" id="biografia" 
                    class="w-full border border-gray-200 rounded-xl px-5 py-4 pl-12 focus:ring-2 focus:ring-pink-300 focus:border-pink-400 transition-all duration-300 outline-none h-40 text-lg shadow-sm resize-none" 
                    placeholder="Cuéntanos algo sobre ti..."></textarea>
          <div class="absolute top-4 left-4 pointer-events-none">
            <i class="fas fa-pencil-alt text-gray-400 text-lg"></i>
          </div>
        </div>
        <div class="flex justify-between mt-2">
          <p class="text-sm text-gray-500">Máximo 200 caracteres</p>
          <p id="charCount" class="text-sm text-gray-500">0/200</p>
        </div>
      </div>

      <!-- Campo Contraseña -->
      <div class="mb-8">
        <label class="block text-gray-700 font-semibold mb-3 text-lg">
          <i class="fas fa-lock text-pink-500 mr-2"></i> Contraseña (opcional)
        </label>
        <div class="relative">
          <input name="contrasena" id="contrasena" type="password" 
                 class="w-full border border-gray-200 rounded-xl px-5 py-4 pl-12 focus:ring-2 focus:ring-pink-300 focus:border-pink-400 transition-all duration-300 outline-none text-lg shadow-sm" 
                 placeholder="Nueva contraseña" />
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <i class="fas fa-lock text-gray-400 text-lg"></i>
          </div>
        </div>
        <p class="text-sm text-gray-500 mt-2">Deja en blanco si no deseas cambiarla</p>
      </div>

      <!-- Campo Foto -->
      <div class="mb-8">
        <label class="block text-gray-700 font-semibold mb-3 text-lg">
          <i class="fas fa-camera text-pink-500 mr-2"></i> Foto de perfil
        </label>
        
        <!-- Vista previa de imagen actual -->
        <div id="currentImagePreview" class="mb-6 text-center">
          <p class="text-gray-600 mb-3">Imagen actual:</p>
          <div class="relative inline-block">
            <img id="currentProfileImage" src="{{ asset('images/default-avatar.png') }}" alt="Imagen actual" 
                 class="mx-auto rounded-full w-32 h-32 object-cover border-4 border-white shadow-lg image-loading">
            <div id="currentImageSpinner" class="absolute inset-0 flex items-center justify-center">
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-pink-500"></div>
            </div>
          </div>
        </div>
        
        <div id="uploadArea" class="flex items-center justify-center px-8 py-10 border-2 border-dashed border-gray-300 rounded-2xl hover:border-pink-400 transition-colors duration-300 relative upload-area">
          <input type="file" id="foto" name="foto" accept="image/*" 
                 class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          <div class="text-center">
            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-600 text-lg">Haz clic o arrastra una imagen aquí</p>
            <p class="text-sm text-gray-500 mt-2">Formatos: JPG, PNG, GIF (Max. 2MB)</p>
          </div>
        </div>
        
        <!-- Vista previa de nueva imagen -->
        <div id="newImagePreview" class="mt-6 hidden text-center">
          <p class="text-gray-600 mb-3">Vista previa de la nueva imagen:</p>
          <div class="flex justify-center gap-6 flex-wrap">
            <div class="text-center">
              <p class="text-sm text-gray-500 mb-2">Anterior</p>
              <img id="currentImg" class="rounded-full w-24 h-24 object-cover border shadow" />
            </div>
            <div class="flex items-center text-gray-400">
              <i class="fas fa-arrow-right text-xl"></i>
            </div>
            <div class="text-center">
              <p class="text-sm text-gray-500 mb-2">Nueva</p>
              <img id="previewImg" class="rounded-full w-24 h-24 object-cover border-2 border-green-500 shadow-lg" />
            </div>
          </div>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="flex flex-col sm:flex-row gap-5 mt-10 pt-8 border-t border-gray-100">
        <button type="submit" class="flex-1 px-8 py-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl shadow-lg hover:from-green-600 hover:to-green-700 hover:shadow-xl transition-all duration-300 font-semibold flex items-center justify-center group transform hover:scale-105">
          <i class="fas fa-save mr-3 group-hover:animate-bounce"></i> Guardar cambios
        </button>
        <button type="button" id="cancelBtn" class="flex-1 px-8 py-4 bg-gradient-to-r from-gray-400 to-gray-500 text-white rounded-xl shadow-lg hover:from-gray-500 hover:to-gray-600 hover:shadow-xl transition-all duration-300 font-semibold flex items-center justify-center transform hover:scale-105">
          <i class="fas fa-times mr-3"></i> Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

{{ include('footer.html.twig') }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Elementos del DOM
  const editBtn = document.getElementById('editBtn');
  const profileEdit = document.getElementById('profileEdit');
  const profileView = document.getElementById('profileView');
  const profileForm = document.getElementById('profileForm');
  const fotoInput = document.getElementById('foto');
  const uploadArea = document.getElementById('uploadArea');
  const newImagePreview = document.getElementById('newImagePreview');
  const previewImg = document.getElementById('previewImg');
  const currentImg = document.getElementById('currentImg');
  const charCount = document.getElementById('charCount');
  const biografia = document.getElementById('biografia');

  const DEFAULT_AVATAR = "{{ asset('images/default-avatar.png') }}";
  let currentImageUrl = DEFAULT_AVATAR;

  // --- Función para cargar imagen de forma segura ---
  function safeImageLoad(imgElement, src, fallback = DEFAULT_AVATAR) {
    return new Promise((resolve) => {
      // Mostrar estado de carga
      imgElement.classList.add('image-loading');
      
      // Ocultar spinner si existe
      const spinnerId = imgElement.id + 'Spinner';
      const spinner = document.getElementById(spinnerId);
      
      const image = new Image();
      image.onload = function() {
        imgElement.src = src;
        imgElement.classList.remove('image-loading');
        imgElement.classList.add('image-loaded');
        if (spinner) spinner.style.display = 'none';
        resolve(true);
      };
      
      image.onerror = function() {
        console.warn(`Error cargando imagen: ${src}, usando fallback`);
        imgElement.src = fallback;
        imgElement.classList.remove('image-loading');
        imgElement.classList.add('image-loaded');
        if (spinner) spinner.style.display = 'none';
        resolve(false);
      };
      
      // Timeout de seguridad
      setTimeout(() => {
        if (imgElement.classList.contains('image-loading')) {
          imgElement.src = fallback;
          imgElement.classList.remove('image-loading');
          imgElement.classList.add('image-loaded');
          if (spinner) spinner.style.display = 'none';
          resolve(false);
        }
      }, 5000);
      
      image.src = src;
    });
  }

  // Contador de caracteres para biografía
  biografia.addEventListener('input', function() {
    const count = this.value.length;
    charCount.textContent = `${count}/200`;
    charCount.classList.toggle('text-red-500', count > 200);
  });

  // Drag & drop para la imagen
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
  });

  uploadArea.addEventListener('drop', handleDrop, false);

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length > 0) {
      fotoInput.files = files;
      handleImageSelection(files[0]);
    }
  }

  // Vista previa de imagen
  fotoInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      handleImageSelection(this.files[0]);
    }
  });

  function handleImageSelection(file) {
    if (!file) return;

    // Validar tipo de archivo
    if (!file.type.match('image.*')) {
      Swal.fire({
        icon: 'error',
        title: 'Tipo de archivo no válido',
        text: 'Por favor, selecciona una imagen (JPG, PNG, GIF)',
        confirmButtonColor: '#ec4899'
      });
      return;
    }
    
    // Validar tamaño (2MB)
    if (file.size > 2 * 1024 * 1024) {
      Swal.fire({
        icon: 'error',
        title: 'Archivo demasiado grande',
        text: 'La imagen debe ser menor a 2MB',
        confirmButtonColor: '#ec4899'
      });
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      previewImg.src = e.target.result;
      currentImg.src = currentImageUrl;
      newImagePreview.classList.remove('hidden');
    };
    reader.onerror = function() {
      Swal.fire({
        icon: 'error',
        title: 'Error al leer el archivo',
        text: 'No se pudo procesar la imagen seleccionada',
        confirmButtonColor: '#ec4899'
      });
    };
    reader.readAsDataURL(file);
  }

  // --- Función para parsear respuesta segura ---
  async function parseResponse(res) {
    const contentType = res.headers.get("content-type");
    if (contentType && contentType.includes("application/json")) {
      return await res.json();
    }
    const text = await res.text();
    throw new Error("Respuesta no es JSON: " + text.substring(0, 100));
  }

  // --- Función para cargar perfil ---
  async function loadProfile() {
    try {
      const res = await fetch('/api/me', { 
        headers: authHeaders(),
        cache: 'no-cache' // Evitar cache para datos actualizados
      });
      
      if (!res.ok) throw new Error(`Error ${res.status}: ${res.statusText}`);

      const user = await parseResponse(res);
      const userName = user.nombre || 'Usuario';
      const userBio = user.biografia || '¡Completa tu biografía para que otros te conozcan mejor!';
      const userPhoto = user.foto || DEFAULT_AVATAR;

      // Actualizar texto inmediatamente
      document.getElementById('profileName').textContent = userName;
      document.getElementById('profileBio').textContent = userBio;
      document.getElementById('nombre').value = userName;
      document.getElementById('biografia').value = userBio;
      charCount.textContent = `${userBio.length}/200`;

      // Cargar imágenes en paralelo
      const profileImage = document.getElementById('profileImage');
      const currentProfileImage = document.getElementById('currentProfileImage');
      const currentImgElement = document.getElementById('currentImg');
      
      await Promise.all([
        safeImageLoad(profileImage, userPhoto),
        safeImageLoad(currentProfileImage, userPhoto),
        safeImageLoad(currentImgElement, userPhoto)
      ]);

      // Guardar ruta actual
      currentImageUrl = userPhoto;
      newImagePreview.classList.add('hidden');
      fotoInput.value = '';

    } catch (err) {
      console.error('Error cargando perfil:', err);
      
      // Cargar avatares por defecto en caso de error
      const images = [
        'profileImage', 
        'currentProfileImage', 
        'currentImg'
      ];
      
      images.forEach(imgId => {
        const img = document.getElementById(imgId);
        if (img) {
          safeImageLoad(img, DEFAULT_AVATAR);
        }
      });

      // Mostrar mensaje de error solo si no es error de autenticación
      if (!err.message.includes('401') && !err.message.includes('403')) {
        Swal.fire({
          icon: 'warning',
          title: 'Información limitada',
          text: 'Algunos datos pueden no estar disponibles',
          confirmButtonColor: '#ec4899',
          timer: 3000
        });
      }
    }
  }

  // --- Headers dinámicos ---
  function authHeaders(isFormData = false) {
    const token = localStorage.getItem('auth_token');
    const headers = {};
    if (token) headers['Authorization'] = 'Bearer ' + token;
    if (!isFormData) headers['Content-Type'] = 'application/json';
    return headers;
  }

  // --- Mostrar/Ocultar edición ---
  editBtn.addEventListener('click', () => {
    profileView.style.animation = 'none';
    setTimeout(() => {
      profileView.classList.add('animate__fadeOutLeft');
      setTimeout(() => {
        profileView.classList.add('hidden');
        profileEdit.classList.remove('hidden');
        profileEdit.classList.add('animate__fadeInRight');
      }, 300);
    }, 10);
  });

  document.getElementById('cancelBtn').addEventListener('click', () => {
    profileEdit.style.animation = 'none';
    setTimeout(() => {
      profileEdit.classList.add('animate__fadeOutRight');
      setTimeout(() => {
        profileEdit.classList.add('hidden');
        profileView.classList.remove('hidden');
        profileView.classList.add('animate__fadeInLeft');
        loadProfile(); // Recargar datos actualizados
      }, 300);
    }, 10);
  });

  // --- Guardar cambios ---
  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Validar biografía
    if (biografia.value.length > 200) {
      Swal.fire({
        icon: 'error',
        title: 'Biografía demasiado larga',
        text: 'La biografía no puede tener más de 200 caracteres',
        confirmButtonColor: '#ec4899'
      });
      return;
    }
    
    const form = new FormData(profileForm);

    try {
      const res = await fetch('/api/profile', {
        method: 'POST',
        headers: authHeaders(true),
        body: form
      });

      const result = await parseResponse(res);

      if (res.ok) {
        Swal.fire({
          icon: 'success',
          title: '¡Éxito!',
          text: result.message,
          background: '#fff',
          color: '#333',
          confirmButtonColor: '#ec4899',
          timer: 2000
        });
        
        profileEdit.classList.add('animate__fadeOutRight');
        setTimeout(() => {
          profileEdit.classList.add('hidden');
          profileView.classList.remove('hidden');
          profileView.classList.add('animate__fadeInLeft');
          loadProfile(); // Recargar con los nuevos datos
        }, 300);
      } else {
        throw new Error(result.error || 'Error actualizando perfil');
      }
    } catch (err) {
      console.error('Error guardando perfil:', err);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: err.message || 'No se pudo actualizar el perfil',
        background: '#fff',
        color: '#333',
        confirmButtonColor: '#ec4899'
      });
    }
  });

  // --- Inicialización ---
  loadProfile().catch(console.error);
});
</script>
{% endblock %}