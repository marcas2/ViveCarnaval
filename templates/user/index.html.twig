{% extends 'base.html.twig' %}
{% block stylesheets %}
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Montserrat', sans-serif;
    }
    .fc {
      font-family: 'Poppins', sans-serif;
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .countdown-box {
      transition: transform 0.3s ease;
    }
    .countdown-box:hover {
      transform: scale(1.05);
    }
    .floating {
      animation: float 6s ease-in-out infinite;
    }
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
      100% { transform: translateY(0px); }
    }
    .gradient-bg {
      background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
    }
    .hero-pattern {
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23f472b6' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
  </style>
{% endblock %}
{% block body %}
{{ include('navbar.html.twig') }}
<div class="max-w-4xl mx-auto p-4 md:p-6">
  <!-- Encabezado con animación -->
  <div class="text-center mb-8 animate__animated animate__fadeInDown">
    <h2 class="text-3xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent">Mi Perfil</h2>
    <p class="text-gray-600 mt-2">Gestiona tu información personal para una mejor experiencia en el Carnaval</p>
    <div class="w-20 h-1 bg-gradient-to-r from-pink-500 to-purple-600 mx-auto mt-4 rounded-full"></div>
  </div>

  {# Vista del perfil #}
  <div id="profileView" class="mb-8 bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-lg overflow-hidden border border-gray-100 animate__animated animate__fadeIn">
    <div class="p-6 md:p-8">
      <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
        <div class="relative">
          <img id="profileImage" src="{{ asset('images/default-avatar.png') }}" alt="avatar" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg">
          <div class="absolute -bottom-2 -right-2 w-10 h-10 rounded-full bg-gradient-to-r from-pink-500 to-purple-600 flex items-center justify-center text-white shadow-md">
            <i class="fas fa-user text-sm"></i>
          </div>
        </div>
        
        <div class="flex-1 text-center md:text-left">
          <h3 id="profileName" class="text-2xl font-bold text-gray-800"></h3>
          <div class="mt-2 flex items-center justify-center md:justify-start text-pink-500">
            <i class="fas fa-star text-sm mr-1"></i>
            <i class="fas fa-star text-sm mr-1"></i>
            <i class="fas fa-star text-sm mr-1"></i>
            <i class="fas fa-star text-sm mr-1"></i>
            <i class="fas fa-star-half-alt text-sm"></i>
          </div>
          <p id="profileBio" class="mt-4 text-gray-600 italic"></p>
          
          <div class="mt-6 grid grid-cols-2 gap-4 max-w-md">
            <div class="flex items-center text-gray-500">
              <i class="fas fa-calendar-day text-pink-500 mr-2"></i>
              <span>Eventos: 12</span>
            </div>
            <div class="flex items-center text-gray-500">
              <i class="fas fa-heart text-pink-500 mr-2"></i>
              <span>Favoritos: 8</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="mt-8 pt-6 border-t border-gray-100 flex justify-center">
        <button id="editBtn" class="px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-full shadow-lg hover:from-pink-600 hover:to-purple-700 hover:shadow-xl transition-all duration-300 font-semibold flex items-center group">
          <i class="fas fa-edit mr-2 group-hover:animate-bounce"></i> Editar perfil
          <i class="fas fa-arrow-right ml-2 text-sm group-hover:translate-x-1 transition-transform duration-300"></i>
        </button>
      </div>
    </div>
  </div>

  {# Formulario de edición #}
  <div id="profileEdit" class="hidden bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 animate__animated animate__fadeIn">
    <div class="bg-gradient-to-r from-pink-500 to-purple-600 p-4 text-white text-center">
      <h3 class="text-xl font-bold"><i class="fas fa-user-edit mr-2"></i> Editar Perfil</h3>
      <p class="text-sm opacity-90">Actualiza tu información personal</p>
    </div>
    
    <form id="profileForm" enctype="multipart/form-data" class="p-6 md:p-8">
      <!-- Campo Nombre -->
      <div class="mb-6">
        <label class="block text-gray-700 font-medium mb-2">
          <i class="fas fa-user text-pink-500 mr-2"></i> Nombre completo
        </label>
        <div class="relative">
          <input name="nombre" id="nombre" required 
                 class="w-full border border-gray-200 rounded-lg px-4 py-3 pl-10 focus:ring-2 focus:ring-pink-300 focus:border-pink-400 transition-all duration-300 outline-none" 
                 placeholder="Ingresa tu nombre completo" />
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-user text-gray-400"></i>
          </div>
        </div>
      </div>

      <!-- Campo Biografía -->
      <div class="mb-6">
        <label class="block text-gray-700 font-medium mb-2">
          <i class="fas fa-pencil-alt text-pink-500 mr-2"></i> Biografía
        </label>
        <div class="relative">
          <textarea name="biografia" id="biografia" 
                    class="w-full border border-gray-200 rounded-lg px-4 py-3 pl-10 focus:ring-2 focus:ring-pink-300 focus:border-pink-400 transition-all duration-300 outline-none h-32" 
                    placeholder="Cuéntanos algo sobre ti..."></textarea>
          <div class="absolute top-3 left-3 pointer-events-none">
            <i class="fas fa-pencil-alt text-gray-400"></i>
          </div>
        </div>
        <p class="text-xs text-gray-500 mt-1">Máximo 200 caracteres</p>
      </div>

      <!-- Campo Contraseña -->
      <div class="mb-6">
        <label class="block text-gray-700 font-medium mb-2">
          <i class="fas fa-lock text-pink-500 mr-2"></i> Contraseña (opcional)
        </label>
        <div class="relative">
          <input name="contrasena" id="contrasena" type="password" 
                 class="w-full border border-gray-200 rounded-lg px-4 py-3 pl-10 focus:ring-2 focus:ring-pink-300 focus:border-pink-400 transition-all duration-300 outline-none" 
                 placeholder="Nueva contraseña" />
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-lock text-gray-400"></i>
          </div>
        </div>
        <p class="text-xs text-gray-500 mt-1">Deja en blanco si no deseas cambiarla</p>
      </div>

      <!-- Campo Foto -->
      <div class="mb-6">
        <label class="block text-gray-700 font-medium mb-2">
          <i class="fas fa-camera text-pink-500 mr-2"></i> Foto de perfil
        </label>
        <div class="flex items-center justify-center px-6 py-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-pink-400 transition-colors duration-300 relative">
          <input type="file" id="foto" name="foto" accept="image/*" 
                 class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          <div class="text-center">
            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
            <p class="text-gray-500">Haz clic o arrastra una imagen aquí</p>
            <p class="text-xs text-gray-400 mt-1">Formatos: JPG, PNG (Max. 2MB)</p>
          </div>
        </div>
        <div id="imagePreview" class="mt-4 hidden text-center">
          <p class="text-sm text-gray-600">Vista previa:</p>
          <img id="previewImg" class="mt-2 mx-auto rounded-full w-24 h-24 object-cover border shadow" />
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="flex flex-col sm:flex-row gap-4 mt-8 pt-6 border-t border-gray-100">
        <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg shadow-lg hover:from-green-600 hover:to-green-700 hover:shadow-xl transition-all duration-300 font-semibold flex items-center justify-center group">
          <i class="fas fa-save mr-2 group-hover:animate-bounce"></i> Guardar cambios
        </button>
        <button type="button" id="cancelBtn" class="flex-1 px-6 py-3 bg-gradient-to-r from-gray-400 to-gray-500 text-white rounded-lg shadow-lg hover:from-gray-500 hover:to-gray-600 hover:shadow-xl transition-all duration-300 font-semibold flex items-center justify-center">
          <i class="fas fa-times mr-2"></i> Cancelar
        </button>
      </div>
    </form>
  </div>
</div>
{{ include('footer.html.twig') }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const editBtn = document.getElementById('editBtn');
  const profileEdit = document.getElementById('profileEdit');
  const profileView = document.getElementById('profileView');
  const profileForm = document.getElementById('profileForm');
  const fotoInput = document.getElementById('foto');
  const imagePreview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');

  const DEFAULT_AVATAR = '/images/default-avatar.png';

  // Vista previa de imagen
  fotoInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        imagePreview.classList.remove('hidden');
      }
      reader.readAsDataURL(this.files[0]);
    }
  });

  // --- Función para parsear respuesta segura ---
  async function parseResponse(res) {
    const contentType = res.headers.get("content-type");
    if (contentType && contentType.includes("application/json")) {
      return await res.json();
    } else {
      const text = await res.text();
      throw new Error("Respuesta no es JSON: " + text);
    }
  }

  // --- Función para cargar perfil ---
  async function loadProfile() {
    try {
      const res = await fetch('/api/me', { headers: authHeaders() });
      if (!res.ok) throw new Error('No autorizado');

      const user = await parseResponse(res);
      document.getElementById('profileName').textContent = user.nombre || 'Usuario';
      document.getElementById('profileBio').textContent = user.biografia || '¡Completa tu biografía para que otros te conozcan mejor!';
      document.getElementById('profileImage').src = user.foto || DEFAULT_AVATAR;

      document.getElementById('nombre').value = user.nombre || '';
      document.getElementById('biografia').value = user.biografia || '';
      
      // Ocultar vista previa al cargar
      imagePreview.classList.add('hidden');
    } catch (err) {
      console.error('Error cargando perfil:', err);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'No se pudo cargar el perfil',
        background: '#fff',
        color: '#333',
        confirmButtonColor: '#ec4899'
      });
    }
  }

  // --- Headers dinámicos ---
  function authHeaders(isFormData = false) {
    const token = localStorage.getItem('auth_token');
    const headers = {};
    if (token) headers['Authorization'] = 'Bearer ' + token;
    if (!isFormData) headers['Content-Type'] = 'application/json';
    return headers;
  }

  // --- Mostrar/Ocultar edición ---
  editBtn.addEventListener('click', () => {
    profileView.classList.add('animate__fadeOutLeft');
    setTimeout(() => {
      profileView.classList.add('hidden');
      profileView.classList.remove('animate__fadeOutLeft');
      profileEdit.classList.remove('hidden');
      profileEdit.classList.add('animate__fadeInRight');
    }, 300);
  });

  document.getElementById('cancelBtn').addEventListener('click', () => {
    profileEdit.classList.add('animate__fadeOutRight');
    setTimeout(() => {
      profileEdit.classList.add('hidden');
      profileEdit.classList.remove('animate__fadeOutRight');
      profileView.classList.remove('hidden');
      profileView.classList.add('animate__fadeInLeft');
      // Resetear vista previa
      imagePreview.classList.add('hidden');
      fotoInput.value = '';
    }, 300);
  });

  // --- Guardar cambios ---
  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = new FormData(profileForm);

    try {
      const res = await fetch('/api/profile', {
        method: 'POST',
        headers: authHeaders(true),
        body: form
      });

      const result = await parseResponse(res);

      if (res.ok) {
        Swal.fire({
          icon: 'success',
          title: '¡Éxito!',
          text: result.message,
          background: '#fff',
          color: '#333',
          confirmButtonColor: '#ec4899',
          timer: 2000
        });
        
        profileEdit.classList.add('animate__fadeOutRight');
        setTimeout(() => {
          profileEdit.classList.add('hidden');
          profileEdit.classList.remove('animate__fadeOutRight');
          profileView.classList.remove('hidden');
          profileView.classList.add('animate__fadeInLeft');
          loadProfile();
        }, 300);
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: result.error || 'Error actualizando perfil',
          background: '#fff',
          color: '#333',
          confirmButtonColor: '#ec4899'
        });
      }
    } catch (err) {
      console.error('Error conexión:', err);
      Swal.fire({
        icon: 'error',
        title: 'Error de conexión',
        text: 'No se pudo conectar con el servidor',
        background: '#fff',
        color: '#333',
        confirmButtonColor: '#ec4899'
      });
    }
  });

  // --- Inicial ---
  await loadProfile();
});
</script>
{% endblock %}