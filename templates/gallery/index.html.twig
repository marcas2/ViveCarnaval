{% extends 'base.html.twig' %}

{% block stylesheets %}
{{ parent() }}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<meta name="csrf-token" content="{{ csrf_token('like') }}">
<style>
    body {
        font-family: 'Inter', sans-serif;
        background: #fafafa;
        color: #262626;
    }
 
    .post-card {
        background: #ffffff;
        border: 1px solid #dbdbdb;
        border-radius: 12px;
        margin-bottom: 24px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
    }
    .post-card:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    .like-animation {
        animation: likeHeart 0.45s ease-in-out;
    }
    @keyframes likeHeart {
        0% { transform: scale(1); }
        25% { transform: scale(1.2); }
        50% { transform: scale(0.95); }
        100% { transform: scale(1); }
    }
    .comment-section {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
        border-top: 1px solid #efefef;
    }
    .comment-section.open {
        max-height: 500px;
    }
    .post-image {
        width: 100%;
        height: auto;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    .post-image:hover {
        transform: scale(1.01);
    }
    .dropdown-menu {
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }
    .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .heart-pulse {
        animation: heartPulse 0.8s ease;
    }
    @keyframes heartPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block title %}Galer√≠a del Carnaval - Comparte tus recuerdos{% endblock %}

{% block body %}
{{ include('navbar.html.twig') }}
<!-- Hero Section -->
<section class="instagram-gradient bg-gradient-to-r from-pink-500 to-fuchsia-600 text-white py-12 md:py-16 relative overflow-hidden">
    <div class="absolute inset-0 bg-black/20"></div>
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
        <div class="text-center animate__animated animate__fadeInUp">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">üì∏ Galer√≠a del Carnaval</h1>
            <p class="text-xl md:text-2xl max-w-3xl mx-auto mb-6 opacity-95">
                Comparte tus momentos especiales y conecta con la comunidad
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                <a href="{{ path('app_gallery_new') }}"
                class="bg-white text-pink-600 px-6 py-3 rounded-xl font-semibold hover:bg-gray-100 transition-all duration-300 flex items-center group shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-plus-circle mr-2 group-hover:scale-110 transition-transform"></i>
                    Compartir Recuerdo
                </a>

                <div class="bg-white/20 backdrop-blur-sm rounded-xl px-4 py-2 inline-flex items-center space-x-2 border border-white/30">
                    <i class="fas fa-users text-yellow-300"></i>
                    <span class="font-semibold">{{ recuerdos|length }} recuerdos compartidos</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Posts Container -->
<div class="max-w-2xl mx-auto px-4 py-8">
    {% for dato in recuerdos %}
        {% set recuerdo = dato.recuerdo %}
        {% set usuario = recuerdo.usuario %}
        
        <div class="post-card fade-in animate__animated animate__fadeInUp" style="animation-delay: {{ loop.index * 0.1 }}s;">
            <!-- Post Header -->
            <div class="flex items-center justify-between p-4">
                <div class="flex items-center space-x-3">
                    <img src="{{ usuario.foto ? asset(usuario.foto) : asset('img/default-avatar.png') }}" 
                         alt="{{ usuario.nombre }}" 
                         class="w-10 h-10 rounded-full object-cover border-2 border-pink-500">
                    <div>
                        <h3 class="font-semibold text-sm">{{ usuario.nombre }}</h3>
                        <p class="text-xs text-gray-500">Publicado recientemente</p>
                    </div>
                </div>
                
                {% if app.user and app.user.id == usuario.id %}
                <!-- Dropdown Menu (Edit/Delete) -->
                <div class="relative">
                    <button class="post-options p-2 rounded-full hover:bg-gray-50 transition-colors">
                        <i class="fas fa-ellipsis-h text-gray-600"></i>
                    </button>
                    <div class="dropdown-menu absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10">
                        <a href="{{ path('app_gallery_edit', {'id': recuerdo.id}) }}" 
                        class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                            <i class="fas fa-edit mr-3 text-blue-500"></i>
                            Editar publicaci√≥n
                        </a>
                        <button onclick="confirmDelete({{ recuerdo.id }})" 
                                class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-gray-50 transition-colors">
                            <i class="fas fa-trash mr-3"></i>
                            Eliminar publicaci√≥n
                        </button>
                    </div>
                </div>
            {% endif %}

            </div>

            {% if recuerdo.tipo == 'foto' %}
                <img src="{{ asset(recuerdo.multimedia) }}" alt="{{ recuerdo.titulo }}" class="rounded-lg w-full">
            {% elseif recuerdo.tipo == 'video' %}
                <video controls class="rounded-lg w-full">
                    <source src="{{ asset(recuerdo.multimedia) }}" type="video/mp4">
                    Tu navegador no soporta la reproducci√≥n de video.
                </video>
            {% endif %}


            <!-- Post Actions -->
            <div class="p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-4">
                        <button class="like-btn flex items-center gap-1 text-2xl {{ dato.likedByUser ? 'text-red-500 heart-pulse' : 'text-gray-800' }}" 
                                data-id="{{ recuerdo.id }}">
                            <i class="fas fa-heart transition-all duration-300"></i>
                        </button>
                        <button class="toggle-comments text-2xl text-gray-800 hover:text-gray-600 transition-colors"
                                data-id="{{ recuerdo.id }}">
                            <i class="far fa-comment"></i>
                        </button>
                    </div>

                </div>

                <!-- Likes Count -->
                <div class="mb-2">
                    <span class="font-semibold text-sm like-count">{{ dato.likes }}</span>
                    <span class="text-sm text-gray-800">me gusta</span>
                </div>

                <!-- Post Description -->
                <div class="mb-2">
                    <p class="text-sm">
                        <span class="font-semibold">{{ usuario.nombre }}</span>
                        {{ recuerdo.descripcion }}
                    </p>
                </div>

                <!-- Comments Toggle -->
                <button class="toggle-comments text-sm text-gray-500 mb-3 hover:text-gray-700 transition-colors"
                        data-id="{{ recuerdo.id }}">
                    üí¨ Ver los <span class="comment-count font-semibold" data-id="{{ recuerdo.id }}">{{ dato.comentarios }}</span> comentarios
                </button>

                <!-- Comments Section -->
                <div id="comments-{{ recuerdo.id }}" class="comment-section">
                    <div class="comments-list space-y-3 py-3"></div>

                    {% if app.user %}
                    <form class="comment-form flex gap-2 items-center pt-2 border-t border-gray-100" data-id="{{ recuerdo.id }}">
                        <input 
                            type="text" 
                            name="comentario"
                            placeholder="A√±ade un comentario..." 
                            class="flex-1 border-0 px-0 py-1 text-sm focus:outline-none focus:ring-0 placeholder-gray-400">
                        <button type="submit" class="text-blue-500 font-semibold text-sm hover:text-blue-700 transition-colors px-2 py-1">
                            Publicar
                        </button>
                    </form>
                    {% else %}
                    <div class="pt-2 border-t border-gray-100">
                        <p class="text-gray-500 text-sm text-center py-2">
                            <a href="#" class="text-blue-500 hover:text-blue-700">Inicia sesi√≥n</a> para comentar.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endfor %}
</div>

{{ include('footer.html.twig') }}

<script>
// Dropdown Menu Toggle
document.querySelectorAll('.post-options').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const dropdown = btn.nextElementSibling;
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            if (menu !== dropdown) menu.classList.remove('open');
        });
        dropdown.classList.toggle('open');
    });
});

// Close dropdowns when clicking outside
document.addEventListener('click', () => {
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.classList.remove('open');
    });
});

// Like Functionality
document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const heartIcon = btn.querySelector('i');

        try {
            const response = await fetch(`/gallery/like/${id}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRF-TOKEN': token
                }
            });
            const data = await response.json();

            if (data.error) {
                Swal.fire('‚ö†Ô∏è', data.error, 'warning');
                return;
            }

            const countEl = btn.closest('.p-4').querySelector('.like-count');
            let count = parseInt(countEl.textContent);

            if (data.liked) {
                heartIcon.classList.remove('far', 'text-gray-800');
                heartIcon.classList.add('fas', 'text-red-500', 'like-animation');
                countEl.textContent = count + 1;
                
                // Add pulse animation to heart
                btn.classList.add('heart-pulse');
                setTimeout(() => btn.classList.remove('heart-pulse'), 800);
            } else {
                heartIcon.classList.remove('fas', 'text-red-500');
                heartIcon.classList.add('far', 'text-gray-800');
                countEl.textContent = count - 1;
            }
        } catch (error) {
            console.error(error);
            Swal.fire('‚ùå', 'Error al procesar el like', 'error');
        }
    });
});

// Delete Confirmation
function confirmDelete(id) {
    Swal.fire({
        title: '¬øEliminar recuerdo?',
        text: 'Esta acci√≥n no se puede deshacer.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar',
        reverseButtons: true,
        background: '#ffffff',
        backdrop: 'rgba(0,0,0,0.4)'
    }).then(result => {
        if (result.isConfirmed) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ path('app_gallery_delete', {'id': 'PLACEHOLDER'}) }}".replace('PLACEHOLDER', id);
            document.body.appendChild(form);
            form.submit();
        }
    });
}

// Comments Functionality
document.querySelectorAll('.toggle-comments').forEach(btn => {
    btn.addEventListener('click', () => {
        const section = document.getElementById('comments-' + btn.dataset.id);
        section.classList.toggle('open');
        if (section.classList.contains('open') && !section.dataset.loaded) {
            loadComments(btn.dataset.id, section);
        }
    });
});

async function loadComments(id, section) {
    try {
        const res = await fetch(`/gallery/comments/${id}`);
        const data = await res.json();

        const list = section.querySelector('.comments-list');
        list.innerHTML = '';
        
        data.forEach(c => {
            const div = document.createElement('div');
            div.classList.add('flex', 'justify-between', 'items-start');
            div.innerHTML = `
                <div class="flex-1">
                    <span class="font-semibold text-sm">${c.usuario}</span>
                    <span class="text-sm ml-2 comment-text">${c.contenido}</span>
                    <div class="text-xs text-gray-400 mt-1">${c.fecha}</div>
                </div>
                ${c.esPropio ? `
                <div class="flex gap-2 text-xs ml-2">
                    <button class="text-blue-500 edit-comment hover:text-blue-700 transition-colors" data-id="${c.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="text-red-500 delete-comment hover:text-red-700 transition-colors" data-id="${c.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>` : ''}
            `;
            list.appendChild(div);
        });

        section.dataset.loaded = true;
        // Update comment count
        const countEl = document.querySelector(`.comment-count[data-id="${id}"]`);
        if (countEl) countEl.textContent = data.length;
    } catch (e) {
        console.error(e);
    }
}

// Comment Form Submission
document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', async e => {
        e.preventDefault();
        const id = form.dataset.id;
        const input = form.querySelector('input[name="comentario"]');
        const comentario = input.value.trim();
        if (!comentario) return;

        try {
            const res = await fetch(`/gallery/comment/${id}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `comentario=${encodeURIComponent(comentario)}`
            });
            const data = await res.json();

            if (data.error) {
                Swal.fire('‚ö†Ô∏è', data.error, 'warning');
                return;
            }

            const section = form.closest('.comment-section');
            section.dataset.loaded = false;
            await loadComments(id, section);
            input.value = '';

        } catch (error) {
            Swal.fire('‚ùå', 'Error al enviar el comentario', 'error');
        }
    });
});

// Edit Comment
document.addEventListener('click', async e => {
    if (e.target.closest('.edit-comment')) {
        const btn = e.target.closest('.edit-comment');
        const id = btn.dataset.id;
        const section = btn.closest('.comment-section');
        const commentDiv = btn.closest('.flex.justify-between.items-start');
        const textEl = commentDiv.querySelector('.comment-text');
        
        if (!textEl) return;
        
        const original = textEl.textContent.trim();

        const { value: nuevo } = await Swal.fire({
            title: 'Editar comentario',
            input: 'text',
            inputValue: original,
            showCancelButton: true,
            confirmButtonText: 'Guardar',
            cancelButtonText: 'Cancelar',
            background: '#ffffff',
            backdrop: 'rgba(0,0,0,0.4)'
        });

        if (nuevo && nuevo !== original) {
            const res = await fetch(`/gallery/comment/edit/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `comentario=${encodeURIComponent(nuevo)}`
            });
            const data = await res.json();

            if (data.success) {
                Swal.fire('‚úÖ', 'Comentario actualizado', 'success');
                const recuerdoId = section.id.split('-')[1];
                section.dataset.loaded = false;
                loadComments(recuerdoId, section);
            } else {
                Swal.fire('‚ö†Ô∏è', data.error || 'Error al actualizar', 'warning');
            }
        }
    }
});

// Delete Comment
document.addEventListener('click', async e => {
    if (e.target.closest('.delete-comment')) {
        const btn = e.target.closest('.delete-comment');
        const id = btn.dataset.id;
        const section = btn.closest('.comment-section');

        const confirm = await Swal.fire({
            title: '¬øEliminar comentario?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'S√≠, eliminar',
            background: '#ffffff',
            backdrop: 'rgba(0,0,0,0.4)'
        });

        if (confirm.isConfirmed) {
            const res = await fetch(`/gallery/comment/delete/${id}`, { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                Swal.fire('üóëÔ∏è', 'Comentario eliminado', 'success');
                const recuerdoId = section.id.split('-')[1];
                section.dataset.loaded = false;
                loadComments(recuerdoId, section);
            } else {
                Swal.fire('‚ö†Ô∏è', data.error || 'Error al eliminar', 'warning');
            }
        }
    }
});
</script>
{% endblock %}